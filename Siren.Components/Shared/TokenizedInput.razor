@inherits SirenBaseComponent

<div class="tokenized-input-container @Class" style="@Style">
    <div class="tokenized-overlay" @ref="_overlayRef">
        @foreach (var segment in _segments)
        {
            @if (segment.Type == TokenSegmentType.Variable)
            {
                @if (VariableInfoProvider != null)
                {
                    var info = VariableInfoProvider(segment.VariableName);
                    <MudMenu Dense="true" ListClass="rounded pa-1"
                             AnchorOrigin="Origin.BottomLeft"
                             TransformOrigin="Origin.TopLeft">
                        <ActivatorContent>
                            <span class="token-variable">
                                <span class="token-bracket">{{</span><span class="token-name">@segment.VariableName</span><span class="token-bracket">}}</span>
                            </span>
                        </ActivatorContent>
                        <ChildContent>
                            <div class="pa-2" style="min-width: 200px;">
                                <SirenText Typo="Typo.caption" Class="mud-text-secondary">Variable</SirenText>
                                <SirenText Typo="Typo.body2" Class="mb-2">@($"{{{{{info?.Key}}}}}")</SirenText>
                                @if (info?.IsFound == true)
                                {
                                    <SirenText Typo="Typo.caption" Class="mud-text-secondary">Value</SirenText>
                                    <SirenText Typo="Typo.body2" Class="mb-2">@info.Value</SirenText>
                                    <SirenText Typo="Typo.caption" Class="mud-text-secondary">Source</SirenText>
                                    <SirenStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                        <SirenText Typo="Typo.body2">@info.Group</SirenText>
                                        @if (info.IsSecret)
                                        {
                                            <Badge Size="Size.Small" Color="Color.Warning" Icon="@SirenIcons.Key">Secret</Badge>
                                        }
                                        else if (info.IsDynamic)
                                        {
                                            <Badge Size="Size.Small" Color="Color.Info">Dynamic</Badge>
                                        }
                                    </SirenStack>
                                }
                                else
                                {
                                    <SirenStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Class="mud-text-warning">
                                        <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Small" />
                                        <SirenText Typo="Typo.body2">Not defined in current environment</SirenText>
                                    </SirenStack>
                                }
                            </div>
                        </ChildContent>
                    </MudMenu>
                }
                else
                {
                    <span class="token-variable" @onclick="() => HandleTokenClick(segment)" @onclick:stopPropagation="true">
                        <span class="token-bracket">{{</span><span class="token-name">@segment.VariableName</span><span class="token-bracket">}}</span>
                    </span>
                }
            }
            else
            {
                <span class="token-text">@segment.Text</span>
            }
        }
        @if (string.IsNullOrEmpty(Value))
        {
            <span class="token-placeholder">@Placeholder</span>
        }
    </div>
    <input type="text"
           class="tokenized-input"
           value="@Value"
           placeholder=""
           @oninput="HandleInput"
           @onfocus="HandleFocus"
           @onblur="HandleBlur"
           @ref="_inputRef" />
</div>

@code {
    private ElementReference _inputRef;
    private ElementReference _overlayRef;
    private List<TokenSegment> _segments = new();
    private bool _isFocused;

    [Parameter]
    public string? Value { get; set; }

    [Parameter]
    public EventCallback<string> ValueChanged { get; set; }

    [Parameter]
    public string Placeholder { get; set; } = "";

    [Parameter]
    public EventCallback<TokenSegment> TokenClicked { get; set; }

    [Parameter]
    public Func<string?, VariableDisplayInfo?>? VariableInfoProvider { get; set; }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        _segments = Tokenize(Value);
    }

    private async Task HandleInput(ChangeEventArgs e)
    {
        var newValue = e.Value?.ToString() ?? "";
        _segments = Tokenize(newValue);
        await ValueChanged.InvokeAsync(newValue);
    }

    private void HandleFocus(FocusEventArgs e)
    {
        _isFocused = true;
    }

    private void HandleBlur(FocusEventArgs e)
    {
        _isFocused = false;
    }

    private async Task HandleTokenClick(TokenSegment segment)
    {
        if (TokenClicked.HasDelegate)
        {
            await TokenClicked.InvokeAsync(segment);
        }
    }

    public async Task FocusAsync()
    {
        await _inputRef.FocusAsync();
    }

    private static readonly System.Text.RegularExpressions.Regex VarPattern =
        new(@"\{\{(\$?\w+(?::\S+)?)\}\}", System.Text.RegularExpressions.RegexOptions.Compiled);

    private static List<TokenSegment> Tokenize(string? text)
    {
        if (string.IsNullOrEmpty(text))
            return new List<TokenSegment>();

        var segments = new List<TokenSegment>();
        var lastIndex = 0;

        foreach (System.Text.RegularExpressions.Match match in VarPattern.Matches(text))
        {
            if (match.Index > lastIndex)
            {
                segments.Add(new TokenSegment(
                    text.Substring(lastIndex, match.Index - lastIndex),
                    TokenSegmentType.Text,
                    null));
            }

            segments.Add(new TokenSegment(
                match.Value,
                TokenSegmentType.Variable,
                match.Groups[1].Value));

            lastIndex = match.Index + match.Length;
        }

        if (lastIndex < text.Length)
        {
            segments.Add(new TokenSegment(
                text.Substring(lastIndex),
                TokenSegmentType.Text,
                null));
        }

        return segments;
    }

    public record TokenSegment(string Text, TokenSegmentType Type, string? VariableName);

    public enum TokenSegmentType { Text, Variable }

    public record VariableDisplayInfo(
        string Key,
        string? Value,
        string? Group,
        bool IsSecret,
        bool IsDynamic,
        bool IsFound
    );
}
