@using Siren.Components.Services
@using Siren.Components.Settings.Controls
@using Siren.Components.Infrastructure.Keyboard
@using Siren.Components.Http
<MudDialog Class="w-75 h-75">
    <TitleContent>
        <SirenStack Row="true">
            <SirenText Typo="Typo.h6">
                <SirenIcon Color="Color.Primary" Class="mr-4" Icon="@SirenIcons.Gears" />
                Settings
            </SirenText>
            <SirenSpacer />
            <SirenText Typo="Typo.h6">
                <MudIconButton Icon="@SirenIcons.Close" OnClick="Close" />
            </SirenText>
        </SirenStack>
    </TitleContent>
    <DialogContent>
        <SirenStack Spacing="12" Class="w-100">
            <SettingsSection Icon="@SirenIcons.Request" Title="Requests">
                <BooleanSettingItem Text="Send with Siren Token header"
                                    Label="Recommended to easily flag requests as test requests"
                                    Value="@true" />

                <BooleanSettingItem Text="Save http response content"
                                          Label="This allows requests to be restored from history, but takes more space on disk."
                                          @bind-Value="@Settings.SaveHttpContent"/>

                <StringSettingItem Text="Default User-Agent"
                                   Label="Sent with requests unless a custom User-Agent header is specified"
                                   @bind-Value="@Settings.DefaultUserAgent" />

                <BaseSettingItem Text="Default HTTP Method"
                                 Label="HTTP method to use when creating new requests">
                    <SimpleHttpRequestMethodSelector AllowNone="true"
                                                     Label=""
                                                     Placeholder="Select default method..."
                                                     SelectedMethod="@Settings.DefaultHttpMethod"
                                                     SelectedMethodChanged="@OnDefaultHttpMethodChanged" />
                </BaseSettingItem>
            </SettingsSection>

            <SettingsSection Icon="@SirenIcons.Response" Title="Response">
                <GenericArraySettingItem T="TimeDisplayOptions"
                                         Text="Time display"
                                         Items="@TimeDisplayOptionsArray"
                                         Value="@Settings.TimeDisplay"
                                         ValueChanged="@OnTimeDisplayChanged"
                                         DisplayTextSelector="@(opt => opt.ToString())" />
                <GenericArraySettingItem T="SizeDisplayOptions"
                                         Text="Size display"
                                         Items="@SizeDisplayOptionsArray"
                                         Value="@Settings.SizeDisplay"
                                         ValueChanged="@OnSizeDisplayChanged"
                                         DisplayTextSelector="@(opt => opt.ToString())" />
            </SettingsSection>

            <SettingsSection Icon="@SirenIcons.AppData" Title="Application Data">
                <ActionSettingItem Text="Delete saved data"
                                   ToolChip="@(new BaseSettingItem.ToolChipData(DisplayFileSize(_appdataSize), $"{_appdataSize} bytes"))"
                                   ButtonText="Delete"
                                   ButtonIcon="@SirenIcons.Delete"
                                   ButtonColor="Color.Error"
                                   ButtonIconColor="Color.Error"
                                   OnButtonClick="DeleteAppData" />
            </SettingsSection>

            <SettingsSection Icon="@SirenIcons.Key" Title="Keyboard Shortcuts">
                @foreach (var shortcut in KeyboardShortcutsService.GetAllShortcuts())
                {
                    <KeyboardShortcutDisplay Shortcut="@shortcut" />
                }
            </SettingsSection>

            <SettingsSection Icon="@SirenIcons.Plugins" Title="Plugins">
                <BooleanSettingItem Text="Enable plugins"
                                    Label="Allow plugins to extend Siren functionality"
                                    @bind-Value="@Settings.PluginState" />
            </SettingsSection>
        </SirenStack>
    </DialogContent>
    <DialogActions>
        <SirenButton OnClick="Close" Variant=" Variant.Text">Cancel</SirenButton>
        <SirenButton Variant="Variant.Filled" OnClick="Save">
            Save
        </SirenButton>
    </DialogActions>
</MudDialog>

@code {
    [Inject]
    SettingsState Settings { get; set; } = default!;

    [Inject]
    ISettingsService SettingsService { get; set; } = default!;

    [Inject]
    ISnackbar Snackbar { get; set; } = default!;

    [Inject]
    IDialogService DialogService { get; set; } = default!;

    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = default!;

    private long _appdataSize = 0;
    private SettingsStateSnapshot? _snapshot;

    private TimeDisplayOptions[] TimeDisplayOptionsArray => Enum.GetValues<TimeDisplayOptions>();
    private SizeDisplayOptions[] SizeDisplayOptionsArray => Enum.GetValues<SizeDisplayOptions>();

    private void Close()
    {
        if (_snapshot != null)
        {
            Settings.RestoreFromSnapshot(_snapshot, notify: false);
        }
        MudDialog.Close(DialogResult.Cancel);
    }

    protected override void OnInitialized()
    {
        _appdataSize = SettingsService.GetAppDataSize();
        _snapshot = Settings.CreateSnapshot();
    }

    public void OnNotify(SettingsState state)
    {
        StateHasChanged();
    }


    private void Save()
    {
        MudDialog.Close(DialogResult.Ok(true));
    }

    protected async Task DeleteAppData()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, BackgroundClass = "siren-dialog" };

        var dialogRef = await DialogService.ShowAsync<DeleteAppDataDialog>("Delete App Data", options);

        var result = await dialogRef.Result;

        if (!result.Canceled)
        {
            SettingsService.PurgeSavedData();

            Snackbar.Add("Purged app data", Severity.Success);
            
            _appdataSize = SettingsService.GetAppDataSize();
            StateHasChanged();
        }
    }

    private void OnTimeDisplayChanged(TimeDisplayOptions value)
    {
        Settings.TimeDisplay = value;
    }

    private void OnSizeDisplayChanged(SizeDisplayOptions value)
    {
        Settings.SizeDisplay = value;
    }

    private void OnDefaultHttpMethodChanged(string? value)
    {
        Settings.DefaultHttpMethod = value;
    }

    protected string DisplayFileSize(long size)
    {
        double kilobytes = size / 1024.0; // 1 KB = 1024 bytes
        double megabytes = kilobytes / 1024.0; // 1 MB = 1024 KB

        if (megabytes > 0.1)
        {
            return $"{megabytes:F2} MB";
        }
        else
        {
            return $"{kilobytes:F2} KB";
        }
        return $"{kilobytes:F2} KB";
    }
}


