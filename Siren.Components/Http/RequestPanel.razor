@using Microsoft.Extensions.Logging
@using Siren.Components.Shared.Notifications
@using Siren.Components.RequestContextPanel
@using Siren.Components.Http
@using Siren.Components.Http.Models
@using Siren.Components.Http.Headers
@using Siren.Components.Http.QueryParams
@using Siren.Components.Variables
@using Siren.Components.RequestContextPanel.Authentication
@implements IDisposable

<SirenStack Spacing="3" Class="h-100">
    <SirenStack Row="true" Spacing="3" Class="w-100" AlignItems="AlignItems.Center">
        <MudPaper Width="100%" Outlined="false" Class="d-flex px-4 pt-8 pb-3" Elevation="0">
            <SirenStack Row="true" Class="w-100 http-request-group"
                Style="border-bottom: solid 1px var(--http-request-dropdown-color); border-top: solid 1px var(--http-request-dropdown-color); border-right: solid 1px var(--http-request-dropdown-color); ">
                <HttpRequestMethodDropdown @ref="_httpMethodDropdown" SelectedMethodChanged="UpdateHttpMethod" />
                <TokenizedInput
                    Style="border-left:solid 1px var(--mud-palette-tertiary);border-right:none;border-top-right-radius:0px;border-bottom-right-radius:0px;"
                    Placeholder="Enter Request URL... e.g., https://api.example.com/v1/resource"
                    Value="@AppState?.Active?.Request?.RequestUri"
                    Class="http-request-input"
                    @ref="_requestUriInput"
                    ValueChanged="UpdateRequestUri" />

                <MudButton OnClick="@OnSendClicked" Variant="Variant.Text"
                    Color="@(Loading? Color.Dark: Color.Inherit)" Class="send-request-button">
                    @(Loading ? "Cancel" : "Send")
                </MudButton>
            </SirenStack>
        </MudPaper>
    </SirenStack>
    <SirenStack Row="true" Spacing="6" Class="w-100 px-4" AlignItems="AlignItems.Center">
        <SirenIcon Color="@Color.Inherit" Icon="@SirenIcons.Request" />
        <SirenText Typo="Typo.h6" Color="Color.Inherit">Request</SirenText>
        <PanelViewDropdown T="RequestPanelViewType"
                           Value="@_currentPanelView"
                           ValueChanged="@HandlePanelViewChanged"
                           Items="@_panelViewTypes"
                           DisplayTextSelector="@(v => v == RequestPanelViewType.QueryParams ? "Query Params" : v.ToString())" />
        @if (_currentPanelView == RequestPanelViewType.Body)
        {
            <MudToggleGroup Value="@CurrentBodyType" ValueChanged="@HandleBodyTypeChanged" T="RequestBodyType" Outlined="true" Size="Size.Small" CheckMark="false"
                Class="pa-1 gap-4 rounded-xl" Color="Color.Primary" Style="height:2rem;">
                <MudToggleItem Class="rounded-xl" Value="@(RequestBodyType.None)" Text="none" Style="height:1.375rem;" />
                <MudToggleItem Class="rounded-xl" Value="@(RequestBodyType.FormData)" Text="form-data" Style="height:1.375rem;" />
                <MudToggleItem Class="rounded-xl" Value="@(RequestBodyType.MultipartFormData)" Text="multipart" Style="height:1.375rem;" />
                <MudToggleItem Class="rounded-xl" Value="@(RequestBodyType.Raw)" Text="raw" Style="height:1.375rem;" />
                <MudToggleItem Class="rounded-xl" Value="@(RequestBodyType.Binary)" Text="binary" Style="height: 1.375rem;" />
            </MudToggleGroup>
        }
        <SirenSpacer />
        <EnvironmentDropdown />
        <SirenIconButton Icon="@SirenIcons.Preview"
            Tooltip="Preview resolved request"
            OnClick="@OnPreviewClicked"
            Size="Size.Small" />
        @if (_currentPanelView == RequestPanelViewType.Body && CurrentBodyType == RequestBodyType.Raw)
        {
            <SirenIconButton Icon="@SirenIcons.Format" Size="Size.Small" Tooltip="Format"
                OnClick="@(async () => await FormatDocumentAsync())" />
            <SirenIconButton Icon="@SirenIcons.Copy" Size="Size.Small" Tooltip="Copy" OnClick="Copy" />
        }
    </SirenStack>
    @if (_currentPanelView == RequestPanelViewType.Body)
    {
        @if (CurrentBodyType == RequestBodyType.FormData)
        {
            <FormDataPanel NetworkRequest="@AppState.Active" />
        }
        else if (CurrentBodyType == RequestBodyType.MultipartFormData)
        {
            <MultipartFormDataPanel NetworkRequest="@AppState.Active" />
        }
        else if (CurrentBodyType == RequestBodyType.Raw)
        {
            <SirenEditor @ref="_editor" EditorId="siren-request-editor" ReadOnly="false" />
        }
        else if (CurrentBodyType == RequestBodyType.Binary)
        {
            <BinaryAttachmentPanel NetworkRequest="@AppState.Active" />
        }
        else
        {
            <SirenStack Spacing="3" Class="w-100 h-100 d-flex" AlignItems="AlignItems.Center" Justify="Justify.Center">
                <SirenIcon Icon="@SirenIcons.Request" Size="Size.Large" Color="Color.Inherit" />
                <SirenText Typo="Typo.h6">No Request Body</SirenText>
                <SirenText Typo="Typo.body2" Class="mud-text-secondary">This request will be sent without a body</SirenText>
            </SirenStack>
        }
    }
    else if (_currentPanelView == RequestPanelViewType.Headers)
    {
        <HeadersEditor Headers="@_requestHeaders"
                       HeadersChanged="@HandleRequestHeadersChanged"
                       ReadOnly="false"
                       AllowEnable="true"
                       ShowSystemHeaders="false"
                       ShowAddButton="true" />
    }
    else if (_currentPanelView == RequestPanelViewType.QueryParams)
    {
        <QueryParamsEditor RequestUri="@AppState?.Active?.Request?.RequestUri"
                           RequestUriChanged="@HandleQueryParamsUriChanged" />
    }
</SirenStack>



@code {
    private string? _requestUri = default!;
    private TokenizedInput? _requestUriInput = default!;

    private HttpRequestMethodDropdown _httpMethodDropdown = default!;

    private RequestPanelViewType _currentPanelView = RequestPanelViewType.Body;
    private readonly RequestPanelViewType[] _panelViewTypes = Enum.GetValues<RequestPanelViewType>();
    private List<HeaderModel> _requestHeaders = new();

    [Parameter]
    public EventCallback SendClicked { get; set; } = default!;

    [Inject]
    public IJsApiService JsApiService { get; set; } = default!;

    [Inject]
    public ISnackbar Snackbar { get; set; } = default!;

    [Inject] protected ILogger<RequestPanel> Logger { get; set; } = default!;

    [Inject] public IDialogService DialogService { get; set; } = default!;

    [Inject] public RequestAuthenticationState AuthState { get; set; } = default!;

    [Parameter] public bool Loading { get; set; } = false;

    private RequestBodyType CurrentBodyType => AppState?.Active?.Request?.BodyType ?? RequestBodyType.Raw;

    private async Task HandleBodyTypeChanged(RequestBodyType newBodyType)
    {
        await SyncEditorToModel();

        if (AppState?.Active?.Request != null)
        {
            AppState.Active.Request.BodyType = newBodyType;
        }

        StateHasChanged();

        if (newBodyType == RequestBodyType.Raw)
        {
            await Task.Yield();
            await SyncModelToEditor();
        }
    }

    private async Task HandlePanelViewChanged(RequestPanelViewType newView)
    {
        // Sync editor content before switching away from Body view
        if (_currentPanelView == RequestPanelViewType.Body)
        {
            await SyncEditorToModel();
        }

        // Load headers when switching to Headers view
        if (newView == RequestPanelViewType.Headers)
        {
            LoadRequestHeaders();
        }

        _currentPanelView = newView;
        StateHasChanged();

        // Restore editor content when switching back to Body view
        if (newView == RequestPanelViewType.Body && CurrentBodyType == RequestBodyType.Raw)
        {
            await Task.Yield();
            await SyncModelToEditor();
        }
    }

    private void LoadRequestHeaders()
    {
        _requestHeaders = AppState?.Active?.Request?.Headers?.ToViewModel() ?? new();
    }

    private async Task HandleRequestHeadersChanged(List<HeaderModel> headers)
    {
        _requestHeaders = headers;
        if (AppState?.Active?.Request != null)
        {
            AppState.Active.Request.Headers = headers
                .Where(h => !string.IsNullOrWhiteSpace(h.Key) && h.Enabled)
                .Select(h => new KeyValuePair<string, string>(h.Key!, h.Value ?? ""))
                .ToList();
            AppState.NotifyActiveRequestChanged();
        }
        await Task.CompletedTask;
    }

    private async Task HandleQueryParamsUriChanged(string newUri)
    {
        if (AppState?.Active?.Request != null)
        {
            AppState.Active.Request.RequestUri = newUri;
            StateHasChanged();
        }
        await Task.CompletedTask;
    }

    private async Task SyncEditorToModel()
    {
        if (_currentPanelView == RequestPanelViewType.Body && CurrentBodyType == RequestBodyType.Raw && _editor?.Editor != null && AppState?.Active?.Request != null)
        {
            try
            {
                AppState.Active.Request.RawBody = await _editor.Editor.GetValue() ?? "";
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "Failed to sync editor content to model");
            }
        }
    }

    private async Task SyncModelToEditor()
    {
        if (_editor?.Editor != null && AppState?.Active?.Request != null)
        {
            try
            {
                await _editor.Editor.SetValue(AppState.Active.Request.RawBody ?? "");
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "Failed to sync model content to editor");
            }
        }
    }

    public async Task<string> GetPayload()
    {
        if (CurrentBodyType == RequestBodyType.FormData)
        {
            return "";
        }
        
        await SyncEditorToModel();
        return AppState?.Active?.Request?.RawBody ?? "";
    }

    public string GetBodyType()
    {
        return CurrentBodyType switch
        {
            RequestBodyType.None => "none",
            RequestBodyType.Raw => "raw",
            RequestBodyType.FormData => "form-data",
            RequestBodyType.Binary => "binary",
            RequestBodyType.MultipartFormData => "multipart-form-data",
            _ => "raw"
        };
    }

    public async Task<string> GetBodyContentAsync()
    {
        if (CurrentBodyType == RequestBodyType.Raw && _editor != null)
        {
            try
            {
                return await _editor.Editor.GetValue() ?? "";
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "Failed to get body content from editor");
                return "";
            }
        }
        return "";
    }

    public async Task SetBodyContentAsync(string content, string? bodyType = null)
    {
        if (!string.IsNullOrEmpty(bodyType) && AppState?.Active?.Request != null)
        {
            AppState.Active.Request.BodyType = bodyType switch
            {
                "none" => RequestBodyType.None,
                "raw" => RequestBodyType.Raw,
                "form-data" => RequestBodyType.FormData,
                "binary" => RequestBodyType.Binary,
                "multipart-form-data" => RequestBodyType.MultipartFormData,
                _ => RequestBodyType.Raw
            };
            AppState.Active.Request.RawBody = content ?? "";
            StateHasChanged();
        }

        if (_editor != null && CurrentBodyType == RequestBodyType.Raw)
        {
            try
            {
                await _editor.Editor.SetValue(content ?? "");
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "Failed to set body content in editor");
            }
        }
    }

    public async Task FocusUriInputAsync()
    {
        if (_requestUriInput != null)
        {
            await _requestUriInput.FocusAsync();
        }
    }

    public async Task FocusHttpMethodDropdownAsync()
    {
        if (_httpMethodDropdown?.MethodDropdown != null)
        {
            await _httpMethodDropdown.MethodDropdown.FocusAsync();
        }
    }

    private SirenEditor _editor = default;
    private Guid? _previousActiveRequestId;

    public async void Copy()
    {
        if (_editor == null)
            return;

        string value = await _editor.Editor?.GetValue();

        if (!string.IsNullOrWhiteSpace(value))
            await JsApiService.CopyToClipboardAsync(value);

        Snackbar.Add($"Copied request body to clipboard", Severity.Info);
    }

    public async Task FormatDocumentAsync()
    {
        try
        {
            if (_editor?.Editor != null)
            {
                await _editor.Editor.Trigger("messaging-editor", "editor.action.formatDocument", "");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error formatting document");
        }
    }

    public async Task OnSendClicked()
    {
        await SendClicked.InvokeAsync();
    }

    private async Task OnPreviewClicked()
    {
        var request = AppState?.Active?.Request;
        if (request == null)
            return;

        // Sync editor content before preview if we're in raw body mode
        if (CurrentBodyType == RequestBodyType.Raw)
        {
            await SyncEditorToModel();
        }

        var parameters = new DialogParameters
        {
            { "Environment", AppState.ActiveEnvironment },
            { "Url", request.RequestUri ?? "" },
            { "Method", request.Method?.Method ?? "GET" },
            { "Headers", request.Headers ?? new List<KeyValuePair<string, string>>() },
            { "Body", CurrentBodyType == RequestBodyType.Raw ? request.RawBody : null },
            { "FormData", (CurrentBodyType == RequestBodyType.FormData || CurrentBodyType == RequestBodyType.MultipartFormData) ? request.FormData : null },
            { "AuthType", AuthState.AuthType },
            { "AuthParams", AuthState.AuthParams }
        };

        var options = new DialogOptions { CloseOnEscapeKey = true, BackgroundClass = "siren-dialog", MaxWidth = MaxWidth.Large };
        await DialogService.ShowAsync<RequestPreviewDialog>("Request Preview", parameters, options);
    }

    [Inject] public SirenAppState AppState { get; set; } = default!;

    public string Method => _httpMethodDropdown?.SelectedMethod ?? "";

    public string Address => _requestUri ?? "";

    protected override void OnInitialized()
    {
        AppState.OnAppStateChanged += HandleAppStateChanged;
        AppState.OnActiveEnvironmentChanged += HandleEnvironmentChanged;
        AppState.OnActiveNetworkRequestChanged += HandleActiveNetworkRequestChanged;
    }

    public void Dispose()
    {
        AppState.OnAppStateChanged -= HandleAppStateChanged;
        AppState.OnActiveEnvironmentChanged -= HandleEnvironmentChanged;
        AppState.OnActiveNetworkRequestChanged -= HandleActiveNetworkRequestChanged;
    }

    protected async void HandleActiveNetworkRequestChanged(SirenNetworkRequest? request)
    {
        if (_previousActiveRequestId.HasValue && _previousActiveRequestId != request?.Id)
        {
            var previousRequest = AppState.NetworkRequests.FirstOrDefault(x => x.Id == _previousActiveRequestId);
            if (previousRequest?.Request != null && previousRequest.Request.BodyType == RequestBodyType.Raw && _editor?.Editor != null)
            {
                try
                {
                    previousRequest.Request.RawBody = await _editor.Editor.GetValue() ?? "";
                }
                catch (Exception ex)
                {
                    Logger.LogWarning(ex, "Failed to save previous request body from editor");
                }
            }
        }

        _previousActiveRequestId = request?.Id;
        
        StateHasChanged();
        
        await Task.Yield();

        if (request == null)
        {
            try
            {
                if (_editor?.Editor != null)
                {
                    await _editor.Editor.SetValue("");
                }
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "Failed to clear editor content");
            }
            return;
        }

        if (request.Request?.BodyType == RequestBodyType.Raw)
        {
            await SyncModelToEditor();
        }
    }

    protected async void HandleAppStateChanged(SirenAppState state)
    {
        if (state?.Active?.Request?.Method?.Method != _httpMethodDropdown.SelectedMethod)
        {
            await _httpMethodDropdown.SetMethod(state?.Active?.Request?.Method?.Method!);
        }
        StateHasChanged();
    }

    protected void HandleEnvironmentChanged(string? environment)
    {
        StateHasChanged();
    }

    protected void UpdateHttpMethod(string? method)
    {
        var req = AppState.Active;

        if (string.IsNullOrWhiteSpace(method))
        {
            req.Request.Method = default!;
        }
        else
        {
            req.Request.Method = new HttpMethod(method);
        }

        AppState.Active = req;

        StateHasChanged();
    }

    protected void UpdateRequestUri(string uri)
    {
        var req = AppState.Active;

        req.Request.RequestUri = uri;

        AppState.Active = req;

        StateHasChanged();
    }

    string GetColor(string method)
    {
        return method switch
        {
            "GET" => "#4caf50",
            "POST" => "#2196f3",
            "PUT" => "#ff9800",
            "DELETE" => "#f44336",
            "PATCH" => "#9c27b0",
            "OPTIONS" => "#3f51b5",
            "HEAD" => "#009688",
            _ => "var(--mud-palette-surface)",
        };
    }

}