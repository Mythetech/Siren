@using MudBlazor
@inherits SirenBaseComponent

<style>
    * {
        --http-request-dropdown-color: @(GetColor(_selectedMethod));
        --http-request-dropdown-hover-bg: @(GetBackgroundColor(_selectedMethod));
    }
</style>

<MudSelect Clearable="@AllowNone"
           Class="@($"{Class} http-request-dropdown mt-0")"
           Dense="true"
           AdornmentColor="Color.Inherit"
           InputClass="mud-palette-inherit"
           Variant="Variant.Text"
           Required="@(!AllowNone)"
           T="string"
           @ref="@MethodDropdown"
           OuterClass="http-request-dropdown-outer"
           Placeholder="@Placeholder"
           Underline="false"
           Value="_selectedMethod"
           ValueChanged="@(async (s) => { _selectedMethod = s; await SelectedMethodChanged.InvokeAsync(s); })"
           Style="@($"max-width:160px;color:{GetColor(_selectedMethod)};border:none;background:linear-gradient(-90deg, var(--mud-palette-surface) 0%, transparent 100%);")">
    @if (AllowNone)
    {
        <MudSelectItem @onmouseenter="@(() => { _active = ""; StateHasChanged(); })"
                       @onmouseleave="@(() => { if (_active == "") { _active = ""; StateHasChanged(); } })"
                       Style="@($"border-left:solid 4px {HttpMethodColors.Default};background-color:{GetBackgroundColor("", IsFocused("") ? 0.2 : 0.1)};color:{HttpMethodColors.Default};")"
                       Value="@((string?)null)">
            <SirenText Style="@($"color:{HttpMethodColors.Default};")">None</SirenText>
        </MudSelectItem>
    }
    @foreach (var method in _methods)
    {
        <MudSelectItem @onmouseenter="@(() => { _active = method; StateHasChanged(); })"
                       @onmouseleave="@(() => { if (_active.Equals(method, StringComparison.OrdinalIgnoreCase)) { _active = ""; StateHasChanged(); } })"
                       Style="@($"border-left:solid 4px {GetColor(method)};background-color:{GetBackgroundColor(method, IsFocused(method) ? 0.2 : 0.1)};color:{GetColor(method)};")"
                       Value="@method">
            <SirenText Style="@($"color:{GetColor(method)};")">@method</SirenText>
        </MudSelectItem>
    }
</MudSelect>

@code {
    string? _selectedMethod;
    List<string> _methods = ["GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS", "HEAD"];

    [Parameter]
    public bool AllowNone { get; set; } = false;

    [Parameter]
    public string Placeholder { get; set; } = "Method";

    [Parameter]
    public string? SelectedMethod 
    { 
        get => _selectedMethod;
        set
        {
            if (_selectedMethod != value)
            {
                _selectedMethod = value;
                StateHasChanged();
            }
        }
    } 

    protected override void OnParametersSet()
    {
        if (_selectedMethod != SelectedMethod)
        {
            _selectedMethod = SelectedMethod;
        }
        base.OnParametersSet();
    }

    public async Task SetMethod(string? method)
    {
        if (!string.IsNullOrWhiteSpace(method))
            method = method.ToUpper();

        _selectedMethod = method;
        await SelectedMethodChanged.InvokeAsync(_selectedMethod);
        StateHasChanged();
    }

    [Parameter]
    public EventCallback<string?> SelectedMethodChanged { get; set; }

    public MudSelect<string>? MethodDropdown { get; set; }

    private string _active = "";

    string GetColor(string? method)
    {
        if (string.IsNullOrWhiteSpace(method))
            return HttpMethodColors.Default;

        return method.ToUpper() switch
        {
            "GET" => HttpMethodColors.Get,
            "POST" => HttpMethodColors.Post,
            "PUT" => HttpMethodColors.Put,
            "DELETE" => HttpMethodColors.Delete,
            "PATCH" => HttpMethodColors.Patch,
            "OPTIONS" => HttpMethodColors.Options,
            "HEAD" => HttpMethodColors.Head,
            _ => HttpMethodColors.Default,
        };
    }

    bool IsFocused(string? method)
    {
        if (string.IsNullOrWhiteSpace(method) && string.IsNullOrWhiteSpace(_active))
            return true;
        return method?.Equals(_active, StringComparison.OrdinalIgnoreCase) ?? false;
    }

    string GetBackgroundColor(string? method, double opacity = 0.1)
    {
        var color = GetColor(method);
        if (color?.IndexOf("#") < 0)
        {
            return "rgba(66, 66, 66, 0.1)";
        }

        var hexColor = color?.TrimStart('#');
        if (string.IsNullOrWhiteSpace(hexColor))
            return "rgba(66, 66, 66, 0.1)";
            
        var r = int.Parse(hexColor.Substring(0, 2), System.Globalization.NumberStyles.HexNumber);
        var g = int.Parse(hexColor.Substring(2, 2), System.Globalization.NumberStyles.HexNumber);
        var b = int.Parse(hexColor.Substring(4, 2), System.Globalization.NumberStyles.HexNumber);
        return $"rgba({r}, {g}, {b}, {opacity})";
    }
}