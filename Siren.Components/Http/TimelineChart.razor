@using Siren.Components.Http.Models
@using System.Linq

<div style="margin: 8px 0;">
    @((MarkupString)GetSvgMarkup())
</div>

@code {
    [Parameter]
    public RequestTimeline? Timeline { get; set; }

    private string GetSvgMarkup()
    {
        var events = new List<(string Name, TimeSpan? Duration)>
        {
            ("DNS", Timeline?.DnsLookup),
            ("TCP", Timeline?.TcpConnection),
            ("TLS", Timeline?.TlsHandshake),
            ("Request", Timeline?.RequestSent),
            ("Wait", Timeline?.WaitingForResponse),
            ("Download", Timeline?.ContentDownload)
        }.Where(e => e.Duration.HasValue && e.Duration.Value.TotalMilliseconds > 0).ToList();

        var totalDuration = Timeline?.TotalDuration.TotalMilliseconds ?? 1;
        if (totalDuration <= 0) totalDuration = 1;
        
        var colors = new[] { "#4caf50", "#2196f3", "#ff9800", "#9c27b0", "#f44336", "#00bcd4" };
        var x = 0.0;
        var colorIndex = 0;
        var svg = new System.Text.StringBuilder();
        svg.Append("<svg width=\"100%\" height=\"60\">");
        
        if (events.Count > 0)
        {
            foreach (var evt in events)
            {
                var width = Math.Max(0.5, (evt.Duration!.Value.TotalMilliseconds / totalDuration) * 100);
                var color = colors[colorIndex % colors.Length];
                var nextX = Math.Min(100, x + width);
                var actualWidth = nextX - x;
                var textX = x + actualWidth / 2;
                
                svg.Append($"<rect x=\"{x:F2}%\" y=\"10\" width=\"{actualWidth:F2}%\" height=\"40\" fill=\"{color}\" opacity=\"0.7\" />");
                
                if (actualWidth > 8)
                {
                    svg.Append($"<text x=\"{textX:F2}%\" y=\"35\" style=\"text-anchor: middle; font-size: 10px; fill: white; font-weight: bold;\">{evt.Name}</text>");
                }
                
                x = nextX;
                colorIndex++;
            }
        }
        else
        {
            svg.Append("<rect x=\"0%\" y=\"10\" width=\"100%\" height=\"40\" fill=\"#e0e0e0\" opacity=\"0.5\" />");
            svg.Append("<text x=\"50%\" y=\"35\" style=\"text-anchor: middle; font-size: 10px; fill: #666;\">No timeline data</text>");
        }
        
        svg.Append("</svg>");
        return svg.ToString();
    }
}

