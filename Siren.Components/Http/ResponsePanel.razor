@using Siren.Components.Settings
@using Siren.Components.Http.Models
@using Siren.Components.Http.Headers
@implements IDisposable

<SirenStack Class="h-100">
    <SirenStack Row="true" Spacing="6" Class="w-100 mt-2 px-4" AlignItems="AlignItems.Center">
        <SirenIcon Icon="@SirenIcons.Response" Color="Color.Inherit"/>
        <SirenText Typo="Typo.h6" Color="Color.Inherit">Response</SirenText>
        <PanelViewDropdown T="ResponsePanelViewType"
                           Value="@_panelViewType"
                           ValueChanged="@HandlePanelViewTypeChanged"
                           Items="@_panelViewTypes" />
        @if (_panelViewType == ResponsePanelViewType.Body)
        {
            <SirenToggleGroup T="ResponseViewType"
                              Value="@_currentViewType"
                              ValueChanged="@HandleViewTypeChanged"
                              Items="@_viewTypes"
                              DisplayTextSelector="@(v => v.ToString().ToLowerInvariant())"/>
        }
        <SirenSpacer/>
        @if (AppState?.Active?.Response?.HttpStatusCode != null)
        {
            <HttpStatusCodeChip IsDarkMode="@AppState.IsDarkMode"
                                StatusCode="@(AppState?.Active?.Response?.HttpStatusCode ?? System.Net.HttpStatusCode.InternalServerError)"/>
        }
        @if (AppState?.Active?.Response?.NetworkInfo != null)
        {
            <NetworkInfoTooltip NetworkInfo="@AppState.Active.Response.NetworkInfo" />
        }
        @if (AppState?.Active?.Response != null)
        {
            <DurationTimelineTooltip Timeline="@AppState.Active.Response.Timeline"
                                     DisplayText="@GetDurationDisplayText()" />
        }
        @if (AppState?.Active?.Response != null)
        {
            <SizeBreakdownTooltip RequestSize="@AppState.Active.Response.RequestSize"
                                 ResponseSize="@AppState.Active.Response.ResponseSize"
                                 DisplayText="@GetSizeDisplayText()" />
        }
        @if (_panelViewType == ResponsePanelViewType.Body && _currentViewType == ResponseViewType.Json)
        {
            <SirenIconButton Icon="@SirenIcons.Format" Size="Size.Small" Tooltip="Format"
                             OnClick="@(async () => await FormatDocumentAsync())"/>
        }
        @if (_panelViewType == ResponsePanelViewType.Body)
        {
            <SirenIconButton Icon="@SirenIcons.Copy" Size="Size.Small" Tooltip="Copy" OnClick="Copy"/>
        }
    </SirenStack>

    @if (_panelViewType == ResponsePanelViewType.Body)
    {
        @if (_currentViewType == ResponseViewType.Json)
        {
            <SirenEditor @ref="_editor" EditorId="siren-response-editor"/>
        }
        else if (_currentViewType == ResponseViewType.Text)
        {
            <MudPaper Class="pa-4 overflow-auto"
                      Style="height: 100%; font-family: 'Consolas', 'Monaco', monospace; font-size: 13px; white-space: pre-wrap; word-break: break-word;"
                      Elevation="0">
                @(_responseText ?? "")
            </MudPaper>
        }
        else if (_currentViewType == ResponseViewType.Html)
        {
            <HtmlViewer HtmlContent="@_responseText" BaseUrl="@(AppState?.Active?.Request?.RequestUri)"/>
        }
    }
    else if (_panelViewType == ResponsePanelViewType.Headers)
    {
        <HeadersEditor Headers="@_responseHeaders"
                       ReadOnly="true"
                       AllowEnable="false"
                       ShowSystemHeaders="true"
                       ShowAddButton="false" />
    }
</SirenStack>

@code {
    [Inject] SirenAppState AppState { get; set; } = default!;

    [Inject] IJsApiService JsApiService { get; set; } = default!;

    [Inject] ISnackbar Snackbar { get; set; } = default!;

    [Inject] SettingsState Settings { get; set; } = default!;

    public SirenEditor _editor { get; set; } = default!;

    private ResponsePanelViewType _panelViewType = ResponsePanelViewType.Body;
    private readonly ResponsePanelViewType[] _panelViewTypes = Enum.GetValues<ResponsePanelViewType>();
    private List<HeaderModel> _responseHeaders = new();

    private ResponseViewType _currentViewType = ResponseViewType.Json;
    private readonly ResponseViewType[] _viewTypes = Enum.GetValues<ResponseViewType>();
    private string? _responseText;

    protected override void OnInitialized()
    {
        AppState.OnAppStateChanged += HandleAppStateChanged;
        Settings.SettingsChanged += HandleSettingsChanged;
    }

    public void Dispose()
    {
        AppState.OnAppStateChanged -= HandleAppStateChanged;
        Settings.SettingsChanged -= HandleSettingsChanged;
    }

    public void HandleSettingsChanged(SettingsState state)
    {
        StateHasChanged();
    }

    private string GetDurationDisplayText()
    {
        if (AppState?.Active?.Response == null)
            return "";

        return FormattingUtils.FormatTime(AppState.Active.Response.Duration, Settings.TimeDisplay);
    }

    private string GetSizeDisplayText()
    {
        if (AppState?.Active?.Response?.ResponseSize == null)
            return "";

        var totalSize = AppState.Active.Response.ResponseSize.Body + AppState.Active.Response.ResponseSize.Headers;
        return FormattingUtils.FormatSize(totalSize, Settings.SizeDisplay);
    }

    private async Task HandlePanelViewTypeChanged(ResponsePanelViewType newViewType)
    {
        _panelViewType = newViewType;

        if (_panelViewType == ResponsePanelViewType.Headers)
        {
            LoadResponseHeaders();
        }

        StateHasChanged();

        if (_panelViewType == ResponsePanelViewType.Body && _currentViewType == ResponseViewType.Json && _editor?.Editor != null)
        {
            await Task.Yield();
            try
            {
                await _editor.Editor.SetValue(_responseText ?? "");
                await FormatDocumentAsync();
            }
            catch
            {
            }
        }
    }

    private void LoadResponseHeaders()
    {
        _responseHeaders.Clear();

        if (AppState?.Active?.Response?.Headers != null)
        {
            foreach (var header in AppState.Active.Response.Headers)
            {
                _responseHeaders.Add(new HeaderModel
                {
                    Key = header.Key,
                    Value = header.Value,
                    IsSystemHeader = true,
                    Enabled = true
                });
            }
        }
    }

    private async Task HandleViewTypeChanged(ResponseViewType newViewType)
    {
        _currentViewType = newViewType;
        StateHasChanged();

        if (_currentViewType == ResponseViewType.Json && _editor?.Editor != null)
        {
            await Task.Yield();
            try
            {
                await _editor.Editor.SetValue(_responseText ?? "");
                await FormatDocumentAsync();
            }
            catch
            {
            }
        }
    }

    public async void HandleAppStateChanged(SirenAppState state)
    {
        _responseText = state?.Active?.DisplayText ?? "";

        // Reload response headers if viewing Headers panel
        if (_panelViewType == ResponsePanelViewType.Headers)
        {
            LoadResponseHeaders();
        }

        if (_currentViewType == ResponseViewType.Json)
        {
            if (state?.Active?.Response != null)
            {
                try
                {
                    await _editor.Editor.SetValue(state.Active.DisplayText);
                    await FormatDocumentAsync();
                }
                catch
                {
                }
            }
            else
            {
                try
                {
                    await _editor.Editor.SetValue("");
                }
                catch
                {
                }
            }
        }

        await InvokeAsync(StateHasChanged);
    }

    public async void Copy()
    {
        string value = _responseText ?? "";

        if (_currentViewType == ResponseViewType.Json && _editor?.Editor != null)
        {
            try
            {
                value = await _editor.Editor.GetValue() ?? "";
            }
            catch
            {
            }
        }

        if (!string.IsNullOrWhiteSpace(value))
            await JsApiService.CopyToClipboardAsync(value);

        Snackbar.Add($"Copied response body to clipboard", Severity.Info);
    }

    private async Task FormatDocumentAsync()
    {
        try
        {
            await _editor.ToggleReadonly();

            await _editor.Editor.Trigger("siren-response-editor", "editor.action.formatDocument", "");

            await _editor.ToggleReadonly();
        }
        catch
        {
        }
    }

}
