@using MudBlazor
@using Mythetech.Framework.Infrastructure.Secrets

<MudDialog>
    <TitleContent>
        <SirenStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
            <SirenIcon Icon="@SirenIcons.Key" />
            <SirenText Typo="Typo.h6">Select Secret</SirenText>
        </SirenStack>
    </TitleContent>
    <DialogContent>
        <SirenStack Spacing="3" Class="py-2" Style="min-width: 400px; min-height: 300px;">
            @if (!SecretManagerState.IsAvailable)
            {
                <MudAlert Severity="Severity.Warning" Dense="true">
                    No secret managers are available. Please configure a secret manager.
                </MudAlert>
            }
            else
            {
                <SirenStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Class="w-100">
                    <MudSelect T="ISecretManager"
                               Value="@SecretManagerState.CurrentManager"
                               ValueChanged="OnManagerChanged"
                               Label="Secret Manager"
                               Dense="true"
                               FullWidth="true"
                               Style="flex: 1;">
                        @foreach (var manager in SecretManagerState.AvailableManagers)
                        {
                            <MudSelectItem Value="@manager">@manager.Name</MudSelectItem>
                        }
                    </MudSelect>
                    <SirenIconButton Icon="@SirenIcons.Refresh"
                                     OnClick="RefreshSecrets"
                                     Tooltip="Refresh secrets"
                                     Disabled="@_isLoading" />
                </SirenStack>

                @if (_isLoading)
                {
                    <SirenStack AlignItems="AlignItems.Center" Justify="Justify.Center" Class="py-4">
                        <MudProgressCircular Indeterminate="true" Size="Size.Medium" />
                        <SirenText Typo="Typo.body2" Color="Color.Secondary">Loading secrets...</SirenText>
                    </SirenStack>
                }
                else if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <MudAlert Severity="Severity.Error" Dense="true">@_errorMessage</MudAlert>
                }
                else
                {
                    <MudTextField @bind-Value="_searchTerm"
                                  Placeholder="Search secrets..."
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@SirenIcons.Search"
                                  Immediate="true"
                                  DebounceInterval="300"
                                  FullWidth="true" />

                    @if (FilteredSecrets.Any())
                    {
                        <MudList T="Secret" Dense="true" Class="overflow-auto" Style="max-height: 250px;">
                            @foreach (var secret in FilteredSecrets)
                            {
                                <MudListItem T="Secret"
                                             Value="@secret"
                                             OnClick="@(() => SelectSecret(secret))"
                                             Class="@($"rounded pa-1{(secret.Key == _selectedSecretKey ? " mud-primary-text" : "")}")">
                                    <SirenStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                        <SirenIcon Icon="@SirenIcons.Key" Size="Size.Small" />
                                        <SirenStack Spacing="0" Class="w-100">
                                            <SirenText Typo="Typo.body2">@secret.Key</SirenText>
                                            @if (!string.IsNullOrEmpty(secret.Name) && secret.Name != secret.Key)
                                            {
                                                <SirenText Typo="Typo.caption" Color="Color.Secondary">@secret.Name</SirenText>
                                            }
                                        </SirenStack>
                                    </SirenStack>
                                </MudListItem>
                            }
                        </MudList>
                    }
                    else if (SecretManagerState.CanSearch())
                    {
                        <SirenStack AlignItems="AlignItems.Center" Justify="Justify.Center" Class="py-4">
                            <SirenIcon Icon="@SirenIcons.Empty" Style="font-size: 2em;" Color="Color.Secondary" />
                            <SirenText Typo="Typo.body2" Color="Color.Secondary">
                                @(string.IsNullOrEmpty(_searchTerm) ? "No secrets found. Click refresh to load." : "No matching secrets.")
                            </SirenText>
                        </SirenStack>
                    }
                    else
                    {
                        <MudTextField @bind-Value="_manualSecretKey"
                                      Label="Secret Key"
                                      Placeholder="Enter the secret key manually"
                                      HelperText="This secret manager doesn't support listing secrets. Enter the key directly."
                                      Dense="true" />
                    }
                }
            }
        </SirenStack>
    </DialogContent>
    <DialogActions>
        <SirenButton Variant="Variant.Text" OnClick="Cancel">Cancel</SirenButton>
        <SirenButton Variant="Variant.Filled"
                     OnClick="Submit"
                     Disabled="@(!CanSubmit)">
            Select
        </SirenButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = default!;

    [Inject]
    public SecretManagerState SecretManagerState { get; set; } = default!;

    private bool _isLoading;
    private string? _errorMessage;
    private string _searchTerm = "";
    private string? _selectedSecretKey;
    private string _manualSecretKey = "";

    private IEnumerable<Secret> FilteredSecrets => string.IsNullOrWhiteSpace(_searchTerm)
        ? SecretManagerState.Secrets
        : SecretManagerState.Secrets.Where(s =>
            s.Key.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
            (s.Name?.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ?? false));

    private bool CanSubmit => !string.IsNullOrWhiteSpace(_selectedSecretKey) ||
                              !string.IsNullOrWhiteSpace(_manualSecretKey);

    protected override async Task OnInitializedAsync()
    {
        if (SecretManagerState.IsAvailable && SecretManagerState.CanSearch() && !SecretManagerState.Secrets.Any())
        {
            await RefreshSecrets();
        }
    }

    private async Task OnManagerChanged(ISecretManager? manager)
    {
        if (manager != null)
        {
            SecretManagerState.SetActiveManager(manager);
            _selectedSecretKey = null;
            _errorMessage = null;

            if (SecretManagerState.CanSearch())
            {
                await RefreshSecrets();
            }
        }
    }

    private async Task RefreshSecrets()
    {
        if (!SecretManagerState.HasActiveManager || !SecretManagerState.CanSearch())
            return;

        _isLoading = true;
        _errorMessage = null;
        StateHasChanged();

        try
        {
            var result = await SecretManagerState.RefreshSecretsAsync();
            if (!result.Success)
            {
                _errorMessage = result.ErrorMessage ?? "Failed to load secrets";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error loading secrets: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void SelectSecret(Secret secret)
    {
        _selectedSecretKey = secret.Key;
        _manualSecretKey = "";
    }

    private void Submit()
    {
        var secretKey = !string.IsNullOrWhiteSpace(_selectedSecretKey)
            ? _selectedSecretKey
            : _manualSecretKey;

        if (!string.IsNullOrWhiteSpace(secretKey))
        {
            var secretReference = SecretReferenceResolver.CreateSecretReference(secretKey);
            MudDialog.Close(DialogResult.Ok(secretReference));
        }
    }

    private void Cancel() => MudDialog.Cancel();
}
