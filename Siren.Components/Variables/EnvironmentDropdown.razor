@using Siren.Components.Shared
@using Siren.Components.Theme
@using MouseEvent = MudBlazor.MouseEvent
@implements IDisposable

<MudMenu @ref="_menu" AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft" Dense="true" ListClass="pa-1" ActivationEvent="MouseEvent.MouseOver">
    <ActivatorContent>
        <MudTooltip Text="Variable Environment" Placement="Placement.Right" Delay="0">
            <SirenChip T="string" 
                       Color="@(string.IsNullOrWhiteSpace(AppState.ActiveEnvironment) ? Color.Warning : Color.Info)" 
                       Value="@(AppState.ActiveEnvironment ?? "None")"
                       Style="cursor: pointer;">
                <SirenStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                    <SirenIcon Icon="@SirenIcons.Environment" Size="Size.Small" />
                    <SirenText Typo="Typo.body2">@(AppState.ActiveEnvironment ?? "None")</SirenText>
                </SirenStack>
            </SirenChip>
        </MudTooltip>
    </ActivatorContent>
    <ChildContent>
        <MudMenuItem Class="@($"{(string.IsNullOrEmpty(AppState.ActiveEnvironment) ? "list-item-active" : "")} rounded-lg px-2 py-0")" OnClick="@(() => SelectEnvironment(null))">None</MudMenuItem>
        @foreach (var env in AvailableEnvironments)
        {
            <MudMenuItem Class="@($"{(env.Equals(AppState.ActiveEnvironment) ? "list-item-active" : "")} rounded-lg px-2 py-0 mt-1")" OnClick="@(() => SelectEnvironment(env))">@env</MudMenuItem>
        } 
    </ChildContent>
</MudMenu>

@code {
    [Inject]
    protected SirenAppState AppState { get; set; } = default!;

    [Inject]
    protected VariableState VariableState { get; set; } = default!;

    private List<string> AvailableEnvironments = new();
    private MudMenu? _menu;

    protected override void OnInitialized()
    {
        LoadEnvironments();
        AppState.OnActiveEnvironmentChanged += HandleEnvironmentChanged;
        VariableState.StateChanged += HandleStateChanged;
    }

    private void HandleStateChanged()
    {
        LoadEnvironments();
    }

    private void LoadEnvironments()
    {
        AvailableEnvironments = VariableState.Environments.Select(e => e.Name).ToList();
        StateHasChanged();
    }

    private void HandleEnvironmentChanged(string? environment)
    {
        StateHasChanged();
    }

    private void SelectEnvironment(string? environment)
    {
        AppState.ActiveEnvironment = environment;
    }

    public void Dispose()
    {
        AppState.OnActiveEnvironmentChanged -= HandleEnvironmentChanged;
        VariableState.StateChanged -= HandleStateChanged;
    }
}

