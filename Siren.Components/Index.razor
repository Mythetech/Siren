@page "/"
@page "/index"
@implements IDisposable
@implements IAsyncDisposable
@using Microsoft.FluentUI.AspNetCore.Components
@using Siren.Components.Theme
@using Siren.Components.Shared
@using Siren.Components.Shared.Notifications
@using Siren.Components.Http
@using Siren.Components.Http.Models
@using Siren.Components.Services
@using Siren.Components.RequestContextPanel
@using Siren.Components.Infrastructure.Keyboard
@using Microsoft.FluentUI.AspNetCore
@using System.Text.Json
@using System.Text.Encodings
@using Microsoft.JSInterop
@using MudBlazor
@using System.Net.Sockets
@using System.Reflection
@using System.Runtime.InteropServices
@using Mythetech.Framework.Desktop.Updates
@using Mythetech.Framework.Infrastructure.Plugins
@using Siren.Components.Settings

<MudStack Row="true" Class="w-100 h-100 ml-1" Spacing="0">
    <FluentMultiSplitter BarSize="1" @ref="_primarySplitter" OnResize="@SplitterResized"
        OnCollapse="@((args) => HandleCollapse(args))" OnExpand="HandleExpand" Height="100%"
        Width="@(sidePanelClosed ? "97%" :"100%")"
        Orientation="Microsoft.FluentUI.AspNetCore.Components.Orientation.Horizontal" Style="overflow-x:clip;">
        <FluentMultiSplitterPane Size="@(!sidePanelClosed ? "80%" : "88%")" Min="400px" Max="100%">
            <FluentMultiSplitter OnResize="@SplitterResized" Height="100%" Width="100%"
                Orientation="Microsoft.FluentUI.AspNetCore.Components.Orientation.Vertical">
                <FluentMultiSplitterPane Size="50%" Min="150px">
                    <MudPaper Height="100%" Elevation="0" Width="100%">
                       <RequestPanel Loading="@_loading" @ref="_requestPanel" SendClicked="HandleSendClicked" /> 
                    </MudPaper>
                </FluentMultiSplitterPane>
                <FluentMultiSplitterPane Size="50%" Min="150px" Collapsible="true">
                    <MudPaper Height="100%" Elevation="0" Width="100%">
                        <ResponsePanel /> 
                    </MudPaper>
                </FluentMultiSplitterPane>
            </FluentMultiSplitter>
        </FluentMultiSplitterPane>
        <FluentMultiSplitterPane Id="request-context-panel" Collapsed="@sidePanelClosed" Collapsible="true"
            Size="@(!sidePanelClosed ? "20%" :"12%")" Min="50px" Max="50%">
            <MudPaper Height="100%" Width="100%">
                <RequestContextPanel @ref="_requestContextPanel" PanelClosed="@(() => ToggleSidePanel())" /> 
            </MudPaper>
        </FluentMultiSplitterPane>
    </FluentMultiSplitter>
    @if (sidePanelClosed)
    {
        <MudStack Spacing="3" AlignItems="AlignItems.Center" Class="w-100 h-100 pl-3"
            Style="min-width: 30px;max-width:30px;">
            <SirenIconButton Tooltip="Authorization" Icon="@SirenIcons.Auth" OnClick="@(() => ToggleSidePanel("Auth"))" />

            <SirenIconButton Tooltip="Headers" Icon="@SirenIcons.Headers" OnClick="@(() => ToggleSidePanel("Headers"))" />

            <SirenIconButton Tooltip="Cookies" Icon="@SirenIcons.Cookies" OnClick="@(() => ToggleSidePanel("Cookies"))" />
        </MudStack>
    }
    <KeyboardShortcuts OnRunRequest="HandleSendClicked" OnNewTab="HandleNewTab" OnFocusUri="HandleFocusUri" OnFocusMethod="HandleFocusMethod" />
</MudStack>

@code {
    [Inject]
    protected SirenAppState AppState { get; set; } = default!;

    [Inject]
    protected IHttpRequestClient HttpRequestClient { get; set; } = default!;

    [Inject] protected IJSRuntime JS { get; set; } = default!;

    [Inject]
    protected ILogger<Index> Logger { get; set; } = default!;

    [Inject]
    protected IVariableSubstitutionService VariableSubstitutionService { get; set; } = default!;

    [Inject]
    protected ISnackbar Snackbar { get; set; } = default!;

    [Inject]
    protected SettingsState Settings { get; set; } = default!;

    [Inject] protected PluginState PluginState { get; set; } = default!;
    [Inject] protected PluginLoader PluginLoader { get; set; } = default!;

    [Inject] protected IUpdateService UpdateService { get; set; } = default!;


    private IJSObjectReference? _module;

    private FluentMultiSplitter _primarySplitter = default!;

    private FluentMultiSplitterPane _contextPanel = default!;

    private RequestPanel _requestPanel = default!;

    private RequestContextPanel.RequestContextPanel _requestContextPanel = default!;

    private bool sidePanelClosed = true;

    private bool _loading = false;

    private string _responseText = "";

    private CancellationTokenSource? _cts = default;

    protected void HandleExpand(FluentMultiSplitterEventArgs args)
    {
        if (args.Pane.Id == "request-context-panel")
        {
            sidePanelClosed = false;
            StateHasChanged();
        }
    }

    protected void HandleCollapse(FluentMultiSplitterEventArgs args)
    {
        if (args.Pane.Id == "request-context-panel")
        {
            sidePanelClosed = true;
            StateHasChanged();
        }
    }

    protected async Task ToggleSidePanel(string selectedTab = "")
    {
        sidePanelClosed = !sidePanelClosed;

        StateHasChanged();

        if (!string.IsNullOrWhiteSpace(selectedTab))
            _requestContextPanel.Open(selectedTab);

        StateHasChanged();
    }

    protected override void OnInitialized()
    {
        AppState.OnActiveNetworkRequestChanged += HandleNetworkRequestChanged;
        AppState.OnFormatRequest += HandleFormatRequest;
        AppState.OnImportRequestBody += HandleImportRequestBody;
        AppState.OnRequestBodyContent += HandleRequestBodyContent;
        if (AppState.Active == null)
        {
            var r = CreateNewNetworkRequest();

            AppState.AddNetworkRequest(r);

            AppState.SetActive(r);
        }
    }

    private async Task<(string? body, string bodyType)> HandleRequestBodyContent()
    {
        if (_requestPanel != null)
        {
            var bodyType = _requestPanel.GetBodyType();
            var body = await _requestPanel.GetBodyContentAsync();
            return (body, bodyType);
        }
        return (null, "none");
    }

    private async void HandleImportRequestBody(string? body, string bodyType)
    {
        if (_requestPanel != null)
        {
            await _requestPanel.SetBodyContentAsync(body ?? "", bodyType);
        }
    }

    private async void HandleFormatRequest()
    {
        if (_requestPanel != null)
        {
            await _requestPanel.FormatDocumentAsync();
        }
    }

    public void HandleNetworkRequestChanged(SirenNetworkRequest? n)
    {
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _module = await JS.InvokeAsync<IJSObjectReference>("import", "./app.js");
            await UpdateService.CheckForUpdatesOnStartupAsync();
        }
    }

    public void Dispose()
    {
        AppState.OnActiveNetworkRequestChanged -= HandleNetworkRequestChanged;
        AppState.OnFormatRequest -= HandleFormatRequest;
        AppState.OnImportRequestBody -= HandleImportRequestBody;
        AppState.OnRequestBodyContent -= HandleRequestBodyContent;
    }

    private bool _containerResizing = false;

    protected void SplitterResized(FluentMultiSplitterResizeEventArgs args)
    {
        Logger.LogDebug("Splitter resized to {NewSize}", args.NewSize);
    }

    protected async Task HandleNewTab()
    {
        var networkRequest = CreateNewNetworkRequest();

        AppState.AddNetworkRequest(networkRequest);
        AppState.SetActive(networkRequest.Id);
        StateHasChanged();
    }

    private SirenNetworkRequest CreateNewNetworkRequest()
    {
        var request = new HttpRequest();

        if (!string.IsNullOrWhiteSpace(Settings.DefaultHttpMethod))
        {
            request.Method = new HttpMethod(Settings.DefaultHttpMethod);
        }

        return new SirenNetworkRequest()
        {
            Name = "New Request",
            Request = request,
        };
    }

    protected async Task HandleFocusUri()
    {
        if (_requestPanel != null)
        {
            await _requestPanel.FocusUriInputAsync();
        }
    }

    protected async Task HandleFocusMethod()
    {
        if (_requestPanel != null)
        {
            await _requestPanel.FocusHttpMethodDropdownAsync();
        }
    }

    protected async Task HandleSendClicked()
    {
        if (string.IsNullOrWhiteSpace(AppState?.Active?.Request?.RequestUri))
        {
            Snackbar.AddSirenError("Request URL Required");
            await _requestPanel.FocusUriInputAsync();
            return;
        }

        if (string.IsNullOrWhiteSpace(AppState?.Active?.Request?.Method?.Method))
        {
            Snackbar.AddSirenError("HTTP Method Required");
            await _requestPanel.FocusHttpMethodDropdownAsync();
            return;
        }

        if (_cts != null)
        {
            await _cts.CancelAsync();
            _cts = null;
            _loading = false;
            _responseText = "Cancelled request.";
            if (AppState?.Active != null)
                AppState.Active.DisplayText = _responseText;
            StateHasChanged();
            return;
        }

        _cts = new();
        _cts.CancelAfter(10_000);

        _loading = true;
        _responseText = "";
        StateHasChanged();

        var active = AppState.Active!;
        var activeEnvironment = AppState.ActiveEnvironment;

        var bodyType = _requestPanel.GetBodyType();
        var contentType = "application/json";
        HttpContent? content = null;

        var resolutionErrors = new List<string>();

        if (bodyType == "form-data")
        {
            contentType = "application/x-www-form-urlencoded";
            var formData = active.Request?.FormData ?? new Dictionary<string, string>();
            var substitutedFormData = new Dictionary<string, string>();
            foreach (var kvp in formData)
            {
                var keyResult = await VariableSubstitutionService.SubstituteVariablesAsync(kvp.Key, activeEnvironment);
                var valueResult = await VariableSubstitutionService.SubstituteVariablesAsync(kvp.Value, activeEnvironment);
                resolutionErrors.AddRange(keyResult.Errors);
                resolutionErrors.AddRange(valueResult.Errors);
                substitutedFormData[keyResult.Value] = valueResult.Value;
            }
            content = new FormUrlEncodedContent(substitutedFormData);
        }
        else if (bodyType == "multipart-form-data")
        {
            var multipartContent = new MultipartFormDataContent();

            var formData = active.Request?.FormData ?? new Dictionary<string, string>();
            foreach (var kvp in formData)
            {
                var keyResult = await VariableSubstitutionService.SubstituteVariablesAsync(kvp.Key, activeEnvironment);
                var valueResult = await VariableSubstitutionService.SubstituteVariablesAsync(kvp.Value, activeEnvironment);
                resolutionErrors.AddRange(keyResult.Errors);
                resolutionErrors.AddRange(valueResult.Errors);
                multipartContent.Add(new StringContent(valueResult.Value), keyResult.Value);
            }

            var attachments = active.Request?.BinaryAttachments ?? new List<BinaryAttachment>();
            foreach (var attachment in attachments)
            {
                var fileContent = new ByteArrayContent(attachment.Data ?? Array.Empty<byte>());
                fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(attachment.ContentType);
                multipartContent.Add(fileContent, "file", attachment.FileName);
            }

            contentType = multipartContent.Headers.ContentType?.ToString() ?? "multipart/form-data";
            content = multipartContent;
        }
        else if (bodyType == "raw")
        {
            if (active.Request?.Headers != null)
            {
                var contentTypeHeader = active.Request.Headers.FirstOrDefault(h =>
                string.Equals(h.Key, "Content-Type", StringComparison.OrdinalIgnoreCase));
                if (contentTypeHeader.Key != null)
                {
                    contentType = contentTypeHeader.Value;
                }
            }
            var payload = await _requestPanel.GetPayload();
            var payloadResult = await VariableSubstitutionService.SubstituteVariablesAsync(payload, activeEnvironment);
            resolutionErrors.AddRange(payloadResult.Errors);
            content = new StringContent(payloadResult.Value, System.Text.Encoding.UTF8, contentType);
        }
        else if (bodyType == "binary")
        {
            var attachments = active.Request?.BinaryAttachments ?? new List<BinaryAttachment>();

            if (attachments.Count == 1)
            {
                var attachment = attachments.First();
                contentType = attachment.ContentType;
                content = new ByteArrayContent(attachment.Data ?? Array.Empty<byte>());
                content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(attachment.ContentType);
            }
            else if (attachments.Count > 1)
            {
                var multipartContent = new MultipartFormDataContent();
                foreach (var attachment in attachments)
                {
                    var fileContent = new ByteArrayContent(attachment.Data ?? Array.Empty<byte>());
                    fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(attachment.ContentType);
                    multipartContent.Add(fileContent, "file", attachment.FileName);
                }
                contentType = multipartContent.Headers.ContentType?.ToString() ?? "multipart/form-data";
                content = multipartContent;
            }
            else
            {
                content = null;
            }
        }
        else
        {
            content = null;
        }

        var uriResult = await VariableSubstitutionService.SubstituteVariablesAsync(active.Request?.RequestUri ?? "", activeEnvironment);
        resolutionErrors.AddRange(uriResult.Errors);
        var requestUri = uriResult.Value;

        var substitutedHeaders = new List<KeyValuePair<string, string>>();
        if (active.Request?.Headers != null)
        {
            foreach (var header in active.Request.Headers)
            {
                var keyResult = await VariableSubstitutionService.SubstituteVariablesAsync(header.Key, activeEnvironment);
                var valueResult = await VariableSubstitutionService.SubstituteVariablesAsync(header.Value, activeEnvironment);
                resolutionErrors.AddRange(keyResult.Errors);
                resolutionErrors.AddRange(valueResult.Errors);
                substitutedHeaders.Add(new KeyValuePair<string, string>(keyResult.Value, valueResult.Value));
            }
        }

        // Show warning if there were resolution errors but still proceed with request
        if (resolutionErrors.Count > 0)
        {
            var distinctErrors = resolutionErrors.Distinct().ToList();
            Logger.LogWarning("Variable resolution errors: {Errors}", string.Join("; ", distinctErrors));
            Snackbar.Add($"Warning: {distinctErrors.Count} variable(s) could not be fully resolved", Severity.Warning);
        }

        var req = new HttpRequest()
        {
            ContentType = contentType,
            RequestUri = requestUri,
            Method = active.Request?.Method ?? HttpMethod.Get,
            Headers = substitutedHeaders,
            FormData = active.Request?.FormData != null ? new Dictionary<string, string>(active.Request.FormData) : new
        Dictionary<string, string>(),
            BinaryAttachments = active.Request?.BinaryAttachments != null ? active.Request.BinaryAttachments.Select(a =>
            a.Copy()).ToList() : new List<BinaryAttachment>(),
            Content = content,
            BodyType = active.Request?.BodyType ?? RequestBodyType.Raw,
            RawBody = active.Request?.RawBody ?? ""
        };

        bool valid = ValidateRequest(req);

        if (!valid)
            return;

        Logger.LogInformation("Sending HTTP request to {RequestUri}", req.RequestUri);

        var r = await HttpRequestClient.SendHttpRequestAsync(req, _cts.Token);

        _cts = default;

        if (r.Error != null)
        {
            string errorMessage;
            if (r.Error is UriFormatException)
            {
                errorMessage = "Invalid URL";
            }
            else if (r.Error is System.Net.Http.HttpRequestException ||
            r.Error is System.Net.Sockets.SocketException)
            {
                errorMessage = "Invalid URL or hostname could not be resolved";
            }
            else
            {
                errorMessage = r.Error.Message;
            }

            Snackbar.AddSirenError(errorMessage);
            await _requestPanel.FocusUriInputAsync();

            _loading = false;
            StateHasChanged();
            return;
        }

        _responseText = r.ResponseText;

        var state = AppState.Active ?? new();
        state.Response = r;
        state.Name = active.Request?.RequestUri ?? req.RequestUri;
        state.DisplayText = _responseText;

        AppState.SetActive(state.Id);

        _loading = false;
        StateHasChanged();
    }

    private bool ValidateRequest(HttpRequest req)
    {

        if (string.IsNullOrWhiteSpace(req.RequestUri))
            return false;

        if (string.IsNullOrWhiteSpace(req.Method.Method))
            return false;

        return true;
    }

    public async ValueTask DisposeAsync()
    {
        if (_module != null)
            await _module.DisposeAsync();
    }

}