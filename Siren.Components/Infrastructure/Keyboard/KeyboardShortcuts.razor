@using Microsoft.FluentUI.AspNetCore.Components
@using FluentKeyCode = Microsoft.FluentUI.AspNetCore.Components.KeyCode
@implements IAsyncDisposable

@code {
    [Inject]
    private IKeyCodeService KeyCodeService { get; set; } = default!;

    [Parameter]
    public EventCallback OnRunRequest { get; set; }

    [Parameter]
    public EventCallback OnNewTab { get; set; }

    [Parameter]
    public EventCallback OnFocusUri { get; set; }

    private Dictionary<FluentKeyCode, EventCallback> _shortcutHandlers = new();

    protected override void OnInitialized()
    {
        var shortcuts = KeyboardShortcutsService.GetAllShortcuts();
        
        foreach (var shortcut in shortcuts)
        {
            _shortcutHandlers[shortcut.Key] = shortcut.Description switch
            {
                "Run active request" => OnRunRequest,
                "New request tab" => OnNewTab,
                "Focus URI input" => OnFocusUri,
                _ => default
            };
        }

        KeyCodeService.RegisterListener(OnKeyDownAsync);
    }

    public async Task OnKeyDownAsync(FluentKeyCodeEventArgs args)
    {
        var shortcut = KeyboardShortcutsService.GetAllShortcuts()
            .FirstOrDefault(s => s.Key == args.Key && 
                               s.RequiresCtrl == (args.CtrlKey || args.MetaKey) &&
                               s.RequiresShift == args.ShiftKey &&
                               s.RequiresAlt == args.AltKey);

        if (shortcut != null && _shortcutHandlers.TryGetValue(shortcut.Key, out var handler))
        {
            await handler.InvokeAsync();
        }
    }

    public ValueTask DisposeAsync()
    {
        KeyCodeService.UnregisterListener(OnKeyDownAsync);
        return ValueTask.CompletedTask;
    }
}

