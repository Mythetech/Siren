@using Microsoft.FluentUI.AspNetCore.Components
@using FluentKeyCode = Microsoft.FluentUI.AspNetCore.Components.KeyCode
@implements IAsyncDisposable

@code {
    [Inject]
    private IKeyCodeService KeyCodeService { get; set; } = default!;

    [Parameter]
    public EventCallback OnRunRequest { get; set; }

    [Parameter]
    public EventCallback OnNewTab { get; set; }

    [Parameter]
    public EventCallback OnFocusUri { get; set; }

    [Parameter]
    public EventCallback OnOpenSettings { get; set; }

    [Parameter]
    public EventCallback OnFocusMethod { get; set; }

    [Parameter]
    public EventCallback OnOpenHistory { get; set; }

    [Parameter]
    public EventCallback OnOpenCollections { get; set; }

    [Parameter]
    public EventCallback OnOpenVariables { get; set; }

    [Parameter]
    public EventCallback OnGoToRequests { get; set; }

    [Parameter]
    public EventCallback OnGoToMockServer { get; set; }

    private Dictionary<string, EventCallback> _shortcutHandlers = new();

    protected override void OnInitialized()
    {
        var shortcuts = KeyboardShortcutsService.GetAllShortcuts();

        foreach (var shortcut in shortcuts)
        {
            _shortcutHandlers[shortcut.Description] = shortcut.Description switch
            {
                "Run active request" => OnRunRequest,
                "New request tab" => OnNewTab,
                "Focus URI input" => OnFocusUri,
                "Open settings" => OnOpenSettings,
                "Focus HTTP method" => OnFocusMethod,
                "Open history panel" => OnOpenHistory,
                "Open collections panel" => OnOpenCollections,
                "Open variables panel" => OnOpenVariables,
                "Go to requests page" => OnGoToRequests,
                "Go to mock server page" => OnGoToMockServer,
                _ => default
            };
        }

        KeyCodeService.RegisterListener(OnKeyDownAsync);
    }

    public async Task OnKeyDownAsync(FluentKeyCodeEventArgs args)
    {
        var shortcut = KeyboardShortcutsService.GetAllShortcuts()
            .FirstOrDefault(s => s.Key == args.Key &&
                               s.RequiresCtrl == (args.CtrlKey || args.MetaKey) &&
                               s.RequiresShift == args.ShiftKey &&
                               s.RequiresAlt == args.AltKey);

        if (shortcut != null && _shortcutHandlers.TryGetValue(shortcut.Description, out var handler))
        {
            await handler.InvokeAsync();
        }
    }

    public ValueTask DisposeAsync()
    {
        KeyCodeService.UnregisterListener(OnKeyDownAsync);
        return ValueTask.CompletedTask;
    }
}

