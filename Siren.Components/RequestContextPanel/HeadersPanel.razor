@using Siren.Components.Http
@using Orientation = Microsoft.FluentUI.AspNetCore.Components.Orientation
@implements IDisposable

<SirenStack Class="w-100 h-100 d-flex">
    <SirenSplitter Orientation="Orientation.Vertical" Panel1Size="40%" Panel2Size="60%" Class="w-100">
        <Panel1>
            <SirenStack Spacing="3" Class="p-1 overflow-y-scroll d-flex h-100 w-100">
                <SirenStack Row="true" Spacing="3" Class="w-100" AlignItems="AlignItems.Center">
                    <SirenText Typo="Typo.body1">Request Headers</SirenText>
                    <SirenSpacer/>
                    <SirenIconButton OnClick="@(() => AddRequestHeader("Key", "Value"))"
                                     Icon="@SirenIcons.Add"
                                     Tooltip="@($"Add Header")"
                                     Class="scale-75"
                                     Size="Size.Medium"
                                     Variant="Variant.Text"
                                     Color="Color.Primary"/>
                </SirenStack>

                <MudDataGrid T="DictionaryViewModel"
                             Items="@allHeaders"
                             Context="context"
                             Class="w-100"
                             Bordered="false"
                             Elevation="0"
                             RowClass="text-truncate hover-error-zone"
                             Style="overflow:hidden;"
                             EditMode="DataGridEditMode.Cell"
                             EditTrigger="DataGridEditTrigger.Manual"
                             CommittedItemChanges="UpdateHeader"
                             ReadOnly="false"
                             Dense="true"
                             Hover="true">
                    <Columns>
                        <MudBlazor.PropertyColumn Property="x => x.Key" Title="Header">
                            <EditTemplate>
                                <MudTextField @bind-Value="@context.Item.Key" 
                                              OnBlur="(() => UpdateHeader(context.Item))"
                                              Disabled="@context.Item.IsSystemHeader"
                                              Class="w-100"/>
                            </EditTemplate>
                            <CellTemplate>
                                <MudTextField Value="@context.Item.Key" 
                                              ReadOnly="@context.Item.IsSystemHeader"
                                              Disabled="@context.Item.IsSystemHeader"
                                              Class="w-100"/>
                            </CellTemplate>
                        </MudBlazor.PropertyColumn>

                        <MudBlazor.PropertyColumn Property="x => x.Value" Title="Value">
                            <EditTemplate>
                                <MudTextField @bind-Value="@context.Item.Value" 
                                              OnBlur="(() => UpdateHeader(context.Item))"
                                              Disabled="@context.Item.IsSystemHeader"
                                              Class="w-100"/>
                            </EditTemplate>
                            <CellTemplate>
                                <MudTextField Value="@context.Item.Value" 
                                              ReadOnly="@context.Item.IsSystemHeader"
                                              Disabled="@context.Item.IsSystemHeader"
                                              Class="w-100"/>
                            </CellTemplate>
                        </MudBlazor.PropertyColumn>
                        <MudBlazor.TemplateColumn Title="">
                            <CellTemplate>
                                <MudMenu ListClass="pa-1" Dense="true">
                                    <ActivatorContent>
                                        <SirenIconButton Icon="@SirenIcons.MoreVert" 
                                                         Variant="Variant.Text"
                                                         Color="Color.Inherit" />
                                    </ActivatorContent>
                                    <ChildContent>
                                        <MudMenuItem class="rounded-lg" Icon="@SirenIcons.Copy" 
                                                     OnClick="@(async () =>
                                                     {
                                                         await JsApiService.CopyToClipboardAsync(context.Item.Key);
                                                         NotifyCopied(context.Item.Key);
                                                     })">
                                            Copy Key
                                        </MudMenuItem>
                                        <MudMenuItem class="rounded-lg" Icon="@SirenIcons.Copy" 
                                                     OnClick="@(async () =>
                                                     {
                                                         await JsApiService.CopyToClipboardAsync(context.Item.Value);
                                                         NotifyCopied(context.Item.Value);
                                                     })">
                                            Copy Value
                                        </MudMenuItem>
                                        @if (!context.Item.IsSystemHeader)
                                        {
                                            <MudDivider />
                                            <MudMenuItem class="rounded-lg" Icon="@SirenIcons.Delete"
                                                         OnClick="@(() => DeleteHeader(context.Item))">
                                                Delete Header
                                            </MudMenuItem>
                                        }
                                    </ChildContent>
                                </MudMenu>
                            </CellTemplate>
                            <EditTemplate>
                                <MudMenu ListClass="pa-1" Dense="true">
                                    <ActivatorContent>
                                        <SirenIconButton Icon="@SirenIcons.MoreVert" 
                                                         Variant="Variant.Text"
                                                         Color="Color.Inherit" />
                                    </ActivatorContent>
                                    <ChildContent>
                                        <MudMenuItem class="rounded-lg" Icon="@SirenIcons.Copy" 
                                                     OnClick="@(async () =>
                                                     {
                                                         await JsApiService.CopyToClipboardAsync(context.Item.Key);
                                                         NotifyCopied(context.Item.Key);
                                                     })">
                                            Copy Key
                                        </MudMenuItem>
                                        <MudMenuItem class="rounded-lg" Icon="@SirenIcons.Copy" 
                                                     OnClick="@(async () =>
                                                     {
                                                         await JsApiService.CopyToClipboardAsync(context.Item.Value);
                                                         NotifyCopied(context.Item.Value);
                                                     })">
                                            Copy Value
                                        </MudMenuItem>
                                        @if (!context.Item.IsSystemHeader)
                                        {
                                            <MudDivider />
                                            <MudMenuItem class="rounded-lg" Icon="@SirenIcons.Delete"
                                                         OnClick="@(() => DeleteHeader(context.Item))">
                                                Delete Header
                                            </MudMenuItem>
                                        }
                                    </ChildContent>
                                </MudMenu>
                            </EditTemplate>
                        </MudBlazor.TemplateColumn>

                    </Columns>
                </MudDataGrid>
            </SirenStack>
        </Panel1>
        <Panel2>
            <SirenStack Spacing="3" Class="p-1 overflow-y-scroll flex-grow-1 d-flex w-100 h-100">
                <SirenText Typo="Typo.body1">Response Headers</SirenText>
                @if (NetworkRequest?.Response?.Headers != null)
                {
                    <MudDataGrid T="DictionaryViewModel"
                                 Items="@(NetworkRequest.Response.Headers.ToViewModel())"
                                 Context="context"
                                 Class="w-100 h-100 d-flex"
                                 Bordered="false"
                                 Elevation="0"
                                 RowClass="text-truncate hover-error-zone"
                                 Style="overflow:hidden;"
                                 ReadOnly="true"
                                 Dense="true"
                                 Hover="true">
                        <Columns>
                            <MudBlazor.PropertyColumn Property="x => x.Key">
                                <CellTemplate>
                                    <SirenStack Row="true" Class="w-100 hover-zone">
                                        <MudTextField @bind-Value="@context.Item.Key"/>
                                        <SirenSpacer/>
                                        <SirenIconButton OnClick="@(async () =>
                                                                  {
                                                                      await JsApiService.CopyToClipboardAsync(context.Item.Key);
                                                                      NotifyCopied(context.Item.Key);
                                                                  })"
                                                         Icon="@SirenIcons.Copy"
                                                         Class="hover-visible hover-visible-primary scale-75"
                                                         Tooltip="@($"Copy key")"
                                                         Size="Size.Small"
                                                         Variant="Variant.Text"
                                                         Color="Color.Transparent"/>
                                    </SirenStack>
                                </CellTemplate>
                            </MudBlazor.PropertyColumn>

                            <MudBlazor.PropertyColumn Property="x => x.Value">
                                <CellTemplate>
                                    <SirenStack Row="true" Class="w-100 hover-zone">
                                        <MudTextField @bind-Value="@context.Item.Value"/>
                                        <SirenSpacer/>
                                        <SirenIconButton OnClick="@(async () =>
                                                                  {
                                                                      await JsApiService.CopyToClipboardAsync(context.Item.Value);
                                                                      NotifyCopied(context.Item.Value);
                                                                  })"
                                                         Icon="@SirenIcons.Copy"
                                                         Class="hover-visible hover-visible-primary scale-75"
                                                         Tooltip="@($"Copy value")"
                                                         Size="Size.Small"
                                                         Variant="Variant.Text"
                                                         Color="Color.Transparent"/>
                                    </SirenStack>
                                </CellTemplate>
                            </MudBlazor.PropertyColumn>
                        </Columns>
                    </MudDataGrid>
                }
            </SirenStack>
        </Panel2>
    </SirenSplitter>
</SirenStack>

@code {
    [Parameter]
    public SirenNetworkRequest NetworkRequest { get; set; }

    [Inject]
    public IJsApiService JsApiService { get; set; } = default!;

    [Inject]
    public ISnackbar Snackbar { get; set; } = default!;

    [Inject]
    public SirenAppState AppState { get; set; } = default!;

    private List<DictionaryViewModel> requestHeaders = new();
    private List<DictionaryViewModel> allHeaders = new();

    protected override void OnInitialized()
    {
        AppState.OnAppStateChanged += HandleAppStateChanged;
        if (NetworkRequest?.Request?.Headers != null)
        {
            requestHeaders = NetworkRequest.Request.Headers.ToViewModel();
        }
        UpdateAllHeaders();
    }

    protected override void OnParametersSet()
    {
        if (NetworkRequest?.Request?.Headers != null)
        {
            requestHeaders = NetworkRequest.Request.Headers.ToViewModel();
        }
        UpdateAllHeaders();
    }

    public void Dispose()
    {
        AppState.OnAppStateChanged -= HandleAppStateChanged;
    }

    private async void HandleAppStateChanged(SirenAppState state)
    {
        if (state?.Active != null)
        {
            if (NetworkRequest == null || state.Active.Id == NetworkRequest.Id)
            {
                NetworkRequest = state.Active;
                if (NetworkRequest?.Request?.Headers != null)
                {
                    requestHeaders = NetworkRequest.Request.Headers.ToViewModel();
                }
                UpdateAllHeaders();
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    private void UpdateAllHeaders()
    {
        allHeaders.Clear();
        
        var userHeaderKeys = new HashSet<string>(
            requestHeaders.Where(h => !string.IsNullOrWhiteSpace(h.Key))
                          .Select(h => h.Key!.ToLowerInvariant()),
            StringComparer.OrdinalIgnoreCase);

        foreach (var header in requestHeaders)
        {
            allHeaders.Add(header);
        }

        if (NetworkRequest?.Response?.ActualRequestHeaders != null)
        {
            var systemHeadersDict = NetworkRequest.Response.ActualRequestHeaders
                .Where(h => !userHeaderKeys.Contains(h.Key.ToLowerInvariant()))
                .ToDictionary(h => h.Key, h => h.Value);

            foreach (var systemHeader in systemHeadersDict.ToViewModel())
            {
                systemHeader.IsSystemHeader = true;
                allHeaders.Add(systemHeader);
            }
        }
    }

    private void AddRequestHeader(string key, string value)
    {
        requestHeaders.Add(new() { Key = key, Value = value });
        SyncToNetworkRequest();
        UpdateAllHeaders();
        StateHasChanged();
    }

    protected void NotifyCopied(string value)
    {
        Snackbar.Add($"Copied `{value}` to clipboard", Severity.Info);
    }

    protected void UpdateHeader(DictionaryViewModel m)
    {
        if (m.IsSystemHeader)
            return;

        var header = requestHeaders.Find(x => x.Id.Equals(m.Id));
        if (header != null)
        {
            header.Key = m.Key;
            header.Value = m.Value;
            SyncToNetworkRequest();
            UpdateAllHeaders();
        }
        StateHasChanged();
    }

    protected void DeleteHeader(DictionaryViewModel m)
    {
        if (m.IsSystemHeader)
            return;

        requestHeaders.Remove(m);
        SyncToNetworkRequest();
        UpdateAllHeaders();
        StateHasChanged();
    }

    private void SyncToNetworkRequest()
    {
        if (NetworkRequest?.Request != null)
        {
            NetworkRequest.Request.Headers = requestHeaders.ToSafeDictionary();
        }
    }

}

