@inherits LayoutComponentBase
@using MudBlazor;
@using Siren.Components.Theme
@using Siren.Components.AppContextPanel
@using Siren.Components.Http
@using Siren.Components.Shared
@using Siren.Components.Variables
@using Microsoft.FluentUI.AspNetCore.Components
@using Siren.Components.Http.Models
@using Siren.Components.Shared.Notifications
@using Siren.Components.Shared.Dialogs.Consumers
@using Siren.Components.Infrastructure
@using Siren.Components.Infrastructure.Keyboard
@using Siren.Components.Settings
@using Siren.Components.AppContextPanel
@using Siren.Components.Configuration
@using Microsoft.Extensions.Logging
@using Mythetech.Framework.Infrastructure
@using Mythetech.Framework.Infrastructure.Plugins
@using MouseEvent = MudBlazor.MouseEvent
@implements IDisposable

<MudThemeProvider @ref="_theme" @bind-IsDarkMode="@AppState.IsDarkMode" Theme="@Theme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />
<GlobalCommandSnackbarProvider />
<DialogCommandProvider />
<JsApiCommandProvider />
<FluentKeyCodeProvider />

<MudLayout>
    <MudAppBar Class="pl-4"
        Style="border-bottom-left-radius:3em;box-shadow:1px 1px 4px 0px var(--mud-palette-primary);border-bottom-right-radius:1.5em;">
        <SirenStack Row="true" Class="w-100" AlignItems="@AlignItems.Center" Spacing="6">
            <MudMenu ActivationEvent="MouseEvent.MouseOver" AnchorOrigin="Origin.BottomLeft"
                TransformOrigin="Origin.TopLeft" Dense="true" ListClass="pa-1">
                <ActivatorContent>
                    <MudText Class="app-header-font" Typo="Typo.h5" Style="cursor: pointer;">Siren</MudText>
                </ActivatorContent>
                <ChildContent>
                    <MudMenuItem Class="rounded" Icon="@SirenIcons.About" OnClick="OpenAboutSiren">About</MudMenuItem>
                    <MudMenuItem Class="rounded" Icon="@SirenIcons.Settings" OnClick="OpenSettingsDialog">Settings
                    </MudMenuItem>
                    <MudMenuItem Class="rounded" Icon="@SirenIcons.Bug" OnClick="OpenReportIssue">Report Issue
                    </MudMenuItem>
                </ChildContent>
            </MudMenu>
            <MenuBar />
            <SirenSpacer />
            <HttpRequestTabs />
        </SirenStack>
    </MudAppBar>
    <MudDrawer @bind-Open="@AppState.SideBarOpen" Variant="DrawerVariant.Mini" Style="overflow: hidden;">
        <ContextPanel IsDarkMode="@AppState.IsDarkMode" DrawerBackgroundColor="@_backgroundColor"
            DrawerToggled="@(() => AppState.ToggleSideBar())"
            DarkModeToggled="@(() => AppState.IsDarkMode = !AppState.IsDarkMode)" />
        <div class="@($"resizer {(!AppState.SideBarOpen ? "d-none" : "")}")"></div>
    </MudDrawer>
    <MudMainContent Class=" pl-2 pr-0" Style="@($"max-height:100dvh;max-width:100vw;overflow:hidden;")">
        <MudContainer Class="px-0 mud-width-full" MaxWidth="MaxWidth.ExtraLarge"
            Style="@($"height:94vh;overflow:hidden;")">
            @Body
        </MudContainer>
    </MudMainContent>
    <KeyboardShortcuts OnOpenSettings="OpenSettingsDialog" />
</MudLayout>


@code {
    [Inject]
    protected SirenAppState AppState { get; set; } = default!;

    [Inject]
    protected Microsoft.JSInterop.IJSRuntime JS { get; set; } = default!;

    [Inject]
    protected IDialogService DialogService { get; set; } = default!;

    [Inject]
    protected ILinkOpenService LinkOpenService { get; set; } = default!;

    [Inject]
    protected AppConfiguration AppConfig { get; set; } = default!;

    [Inject]
    protected SettingsState Settings { get; set; } = default!;

    [Inject]
    protected VariableState VariableState { get; set; } = default!;

    [Inject] protected PluginState PluginState { get; set; } = default!;

    [Inject] protected IPluginAssetLoader PluginLoader { get; set; } = default!;

    [Inject] protected ILogger<MainLayout> Logger { get; set; } = default!;

    private Func<string> GetWidth => () => AppState.SideBarOpen ? "74vw" : "calc(100vw - 52px)";

    protected MudThemeProvider _theme { get; set; } = default!;

    public bool _isDarkMode = false;
    
    private bool _assetsLoaded = false;

    private string _backgroundColor => (!AppState.IsDarkMode ? $"background-color:{_theme.Theme.PaletteLight.OverlayLight}"
    : $"background-color:{_theme.Theme.PaletteDark.Black}");

    private MudTheme Theme { get; } = new SirenTheme();

    private List<SirenNetworkRequest> _networkRequests = new();

    private bool _hasRestoredEnvironment = false;

    protected override void OnInitialized()
    {
        AppState.OnDarkModeChanged += HandleDarkModeChange;
        AppState.OnActiveEnvironmentChanged += HandleActiveEnvironmentChanged;
        VariableState.StateChanged += HandleVariableStateChanged;
        PluginState.StateChanged += OnPluginStateChanged;
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            AppState.SetThemeProvider(_theme);
        }

        base.OnAfterRender(firstRender);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await AppState.SetSystemColorMode();
            if (!_hasRestoredEnvironment)
            {
                RestoreLastActiveEnvironment();
                _hasRestoredEnvironment = true;
            }
        }
        
        if (firstRender || !_assetsLoaded)
        {
            await LoadAllPluginAssetsAsync();
            _assetsLoaded = true;
            StateHasChanged();
        }

        await base.OnAfterRenderAsync(firstRender);
    }

    protected async void HandleDarkModeChange(bool isDarkMode)
    {
        try
        {
            await BlazorMonaco.Editor.Global.SetTheme(JS, isDarkMode ? "vs-dark" : "vs");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to set Monaco editor theme");
        }
    }

    protected async Task OpenSettingsDialog()
    {
        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            BackgroundClass = "siren-dialog",
            MaxWidth = MaxWidth.Medium
        };

        var dialog = await DialogService.ShowAsync<SettingsDialog>("Settings", options);
        var result = await dialog.Result;
    }

    protected async Task OpenAboutSiren()
    {
        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            BackgroundClass = "siren-dialog",
            MaxWidth = MaxWidth.Small
        };

        var dialog = await DialogService.ShowAsync<AboutSiren>("About", options);
        var result = await dialog.Result;
    }

    protected async Task OpenReportIssue()
    {
        await LinkOpenService.OpenLinkAsync(AppConfig.ReportIssueUrl);
    }

    private void HandleActiveEnvironmentChanged(string? environment)
    {
        Settings.LastActiveEnvironment = environment;
    }

    private void HandleVariableStateChanged()
    {
        if (_hasRestoredEnvironment)
        {
            ValidateCurrentEnvironment();
        }
        else
        {
            RestoreLastActiveEnvironment();
            _hasRestoredEnvironment = true;
        }
    }

    private void ValidateCurrentEnvironment()
    {
        var currentEnvironment = AppState.ActiveEnvironment;
        if (string.IsNullOrWhiteSpace(currentEnvironment))
        {
            return;
        }

        var availableEnvironments = VariableState.Environments.Select(e => e.Name).ToList();

        if (!availableEnvironments.Contains(currentEnvironment))
        {
            AppState.ActiveEnvironment = null;
            Settings.LastActiveEnvironment = null;
        }
    }

    private void RestoreLastActiveEnvironment()
    {
        if (string.IsNullOrWhiteSpace(Settings.LastActiveEnvironment))
        {
            return;
        }

        var availableEnvironments = VariableState.Environments.Select(e => e.Name).ToList();

        if (availableEnvironments.Contains(Settings.LastActiveEnvironment))
        {
            AppState.ActiveEnvironment = Settings.LastActiveEnvironment;
        }
        else
        {
            Settings.LastActiveEnvironment = null;
        }
    }
    
    private async Task LoadAllPluginAssetsAsync()
    {
        foreach (var plugin in PluginState.EnabledPlugins)
        {
            await PluginLoader.LoadPluginAssetsAsync(plugin);
        }
    }

    private void OnPluginStateChanged(object? sender, EventArgs e)
    {
        _assetsLoaded = false;
        InvokeAsync(StateHasChanged);
    }


    public void Dispose()
    {
        AppState.OnDarkModeChanged -= HandleDarkModeChange;
        AppState.OnActiveEnvironmentChanged -= HandleActiveEnvironmentChanged;
        VariableState.StateChanged -= HandleVariableStateChanged;
        PluginState.StateChanged -= OnPluginStateChanged;
    }

}